# --------------------------------------------
#   CLOCK DOMAINS
# --------------------------------------------

set prc_clock_period 15.62
netlist clock -group PLL_REF_CLK -period $prc_clock_period PLL_REF_CLK
# Buffered version of the clock goes in same group
netlist clock -group PLL_REF_CLK -period $prc_clock_period pll_ref_clk_ctrl_inst.altclkctrl_0.clkctrl_altclkctrl_0_sub_component.clkctrl1.outclk
# The PL SPI logic is a divided down version of the ref_CLK and its timing is controlled by the FPGA
netlist clock -group PLL_REF_CLK -period [expr {$prc_clock_period / 2}] PL_CPLD_SCLK

set CLK_100_period 10.000
netlist clock -group CLK_100_PLL -period $CLK_100_period CLK_100
# Pll outputs (50MHz, 250MHz, 40MHz)
netlist clock -group CLK_100_PLL -period [expr {$CLK_100_period * 2}] pll_inst.altpll_component.clk_wire\[0\]
netlist clock -group CLK_100_PLL -period [expr {$CLK_100_period / 2.5}] pll_inst.altpll_component.clk_wire\[1\]
netlist clock -group CLK_100_PLL -period [expr {$CLK_100_period * 2.5}] pll_inst.altpll_component.clk_wire\[2\]
# The following clocks are generated by Altera's pll model. One is the input clock, the other is the signal used to gate
# output clocks, also detected on the clock paths.
netlist clock -group CLK_100_PLL -period $CLK_100_period pll_inst.altpll_component.cyclone3_inclk\[1\]
netlist clock -group CLK_100_PLL -period $CLK_100_period pll_inst.altpll_component.pll_lock
# The following clocks are generated by Altera's on-chip flash model.
netlist clock -group CLK_100_PLL -period [expr {$CLK_100_period / 2}] flash_inst.onchip_flash_0.altera_onchip_flash_block.osc

set ps_sclk_period 200.000
netlist clock -group PS_CPLD_SCLK -period $ps_sclk_period PS_CPLD_SCLK

netlist clock -group VAsyncClk -period 100.000 -virtual VAsyncClk

# Asynchronous outputs and constants
netlist port domain -clock VAsyncClk [list IPASS_POWER_EN_FAULT PCIE_RESET \
                                           TPM_RESET_n PS_CLK_ON_CPLD PL_CPLD_IRQ]

netlist clock -group IPASS_SCL -period 10000.000 IPASS_SCL


# CLK100 Domain
netlist port domain -clock CLK_100 [list PWR_SUPPLY_CLK_*]

# CLK50
netlist port domain -clock CLK_100_PLL  [list DB_JTAG_* ]
netlist port domain -clock CLK_100_PLL  [list PWR_EN_5V_OSC_* IPASS_POWER_DISABLE QSFP*_LED_* ]
netlist port domain -clock CLK_100_PLL  [list IPASS_PRESENT_N ]
netlist port domain -clock CLK_100_PLL  [list DB_REF_CLK DB_ARST]
netlist port domain -clock CLK_100_PLL  [list DIO_DIRECTION_*]

# CLK250 Domain
netlist port domain -clock CLK_100_PLL [list LMK32_CS_N TPM_CS_N PHASE_DAC_CS_N DB_CALEEPROM_CS_N CLK_DB_CS_N]

netlist port domain -clock PS_CPLD_SCLK [list LMK32_SCLK        LMK32_MOSI        LMK32_MISO        \
                                              TPM_SCLK          TPM_MOSI          TPM_MISO          \
                                              PHASE_DAC_SCLK    PHASE_DAC_MOSI                      \
                                              DB_CALEEPROM_SCLK DB_CALEEPROM_MOSI DB_CALEEPROM_MISO \
                                              CLK_DB_SCLK       CLK_DB_MOSI       CLK_DB_MISO ]


netlist port domain -clock PL_CPLD_SCLK  [list DB_CTRL_* PL_CPLD_MOSI PL_CPLD_CS_N PL_CPLD_MISO]
netlist port domain -clock IPASS_SCL  [list IPASS_SDA]
netlist port domain -clock PS_CPLD_SCLK  [list PS_CPLD_MOSI PS_CPLD_MISO PS_CPLD_CS_N]


# --------------------------------------------
#   RESET DECLARATION
# --------------------------------------------
netlist reset -group pll_locked_reset -sync -async -active_low pll_inst.altpll_component.pll_lock
netlist reset -group pll_locked_reset -sync -async -active_high reset_clk50
netlist reset -group pll_locked_reset -sync -async -active_high reset_clk40
netlist reset -group power_on_reset_clk100 -sync -async -active_high power_on_reset_clk100
netlist reset -group ps_cs_n -sync -async -active_high ps_spi_cs_n_decoded\[0\]
netlist reset -group pl_cs_n -sync -async -active_high PL_CPLD_CS_N

netlist port resetdomain -reset power_on_reset_clk100 -async -active_high \
  [list PWR_SUPPLY_CLK_* ]


netlist port resetdomain -reset reset_clk50 -async -active_high \
  [list PWR_EN_5V_OSC_* IPASS_POWER_DISABLE QSFP*_LED* DIO_DIRECTION_* \
        DB_REF_CLK DB_ARST DB_JTAG_*]


netlist port resetdomain -reset ps_cs_n -async -active_low \
  [list LMK32_* TPM_* PHASE_DAC_* DB_CALEEPROM_* CLK_DB_* PS_CPLD_*]


netlist port resetdomain -reset pl_cs_n -async -active_low \
  [list DB_CTRL_* PL_CPLD_MOSI PL_CPLD_SCLK PL_CPLD_MISO]


netlist reset -group VAsyncReset -async -sync -active_high -virtual VAsyncReset
netlist port resetdomain -reset VAsyncReset -async -active_high \
  [list IPASS_POWER_EN_FAULT PCIE_RESET  TPM_RESET_n PS_CLK_ON_CPLD PL_CPLD_IRQ \
        IPASS_S* IPASS_PRESENT_N]

cdc reconvergence on
cdc preference reconvergence -depth 1

# --------------------------------------------
#   MODEL DECLARATION
# --------------------------------------------

# Handshake model declaration
hier block handshake -user_specified
hier clock -module handshake clk_a
hier clock -module handshake clk_b
hier reset -module handshake rst_a -async -active_high
hier port domain -module handshake -clock clk_a \
  [list valid_a data_a busy_a]
hier port domain -module handshake -clock clk_b \
  [list valid_b data_b]
hier port resetdomain -module handshake -reset rst_a \
  [list valid_a data_a busy_a]

# Double-Synchronizer
hier block synchronizer -user_specified
hier clock -module synchronizer clk
hier reset -module synchronizer rst -async -active_high
hier port domain -module synchronizer -clock clk \
  [list out]
hier port resetdomain -module synchronizer -reset rst \
  [list out]
